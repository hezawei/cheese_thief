# 《奶酪大盗》代码细节实现补充文档

> 对「代码实现大纲」的逐模块、逐函数、逐交互的细节补充。  
> 用自然语言穷举所有要做的事情，不遗漏任何分支和边界情况。

---

## 一、项目初始化细节

### 1.1 monorepo 结构处理

`shared/` 不是独立 npm 包，通过 TypeScript 路径别名被前后端直接引用：
- 前端 `vite.config.ts` 配 `resolve.alias`：`@shared` 指向 `../shared`。
- 后端 `tsconfig.json` 配 `paths`：`@shared/*` 指向 `../shared/*`。
- import 时统一写 `import { GamePhase } from '@shared/types'`。

### 1.2 前端初始化

Vite 创建 React+TS 项目后要做的事：

1. 装 TailwindCSS v4：`tailwindcss` + `@tailwindcss/vite`（不再需要 postcss/autoprefixer）。`globals.css` 顶部写 `@import "tailwindcss";`，然后用 `@theme {}` 定义自定义断点和颜色。不再需要 `tailwind.config.ts`。
2. 装 shadcn/ui：`npx shadcn@latest init`（CLI 包名已从 shadcn-ui 改为 shadcn），按需 add：`npx shadcn@latest add button input card dialog badge avatar toast progress select switch collapsible`。
3. 其他依赖：`socket.io-client`、`zustand`（v5）、`motion`（原 framer-motion，import 从 `"motion/react"`）、`react-router`（v7，原 react-router-dom 已合并）、`uuid`、`vite-plugin-pwa`。
4. `vite.config.ts`：插件加 `tailwindcss()` （从 `@tailwindcss/vite` 引入） + `react()`；alias `@` -> `src/`、`@shared` -> `../shared`；PWA 插件；`server.host: true`。
5. `tsconfig.json` + `tsconfig.app.json`：paths `@/*` 和 `@shared/*`、strict true、jsx react-jsx。Vite 7 默认拆分为三个 tsconfig 文件，需在 tsconfig.json 和 tsconfig.app.json 中都配 paths。

### 1.3 后端初始化

1. 装 `express`、`socket.io`、`cors`、`uuid`；dev 依赖 `typescript`、`tsx`（热重载）、各类 `@types`。
2. `tsconfig.json`：target ES2022、outDir ./dist、paths `@shared/*`、include 加上 `../shared/**/*.ts`。
3. scripts：`dev` 用 `tsx watch src/index.ts`、`build` 用 `tsc`、`start` 用 `node dist/index.js`。

### 1.4 shared/ 要点

- 所有 enum 和 interface 用 `export` 导出。
- events.ts 的事件对象用 `as const` 断言让 TS 推出字面量类型。
- rules.ts 导出 `getRules(playerCount)` 函数做边界检查。

---

## 二、全局基础层细节

### 2.1 globals.css 要做的事

按顺序：
1. TailwindCSS v4 入口：`@import "tailwindcss";`（不再用 `@tailwind base/components/utilities` 三行指令）。
2. shadcn 的 CSS 变量改成奶酪主题色：`--background` 改棕 `#451A03`、`--foreground` 改浅黄 `#FEF3C7`、`--primary` 改 `#FBBF24`。
3. iOS 安全区域变量：`--sat/--sab/--sal/--sar` 用 `env(safe-area-inset-*)`。
4. 根字号动态缩放：`font-size: calc(16px * (100vw / 390))`，加 min/max 限制。
5. body 样式：`overflow:hidden`、`overscroll-behavior:none`、`-webkit-font-smoothing:antialiased`、`-webkit-tap-highlight-color:transparent`、`-webkit-touch-callout:none`、`user-select:none`、`touch-action:manipulation`、`position:fixed; width:100%; height:100%`。
6. 滚动条隐藏：`::-webkit-scrollbar { display:none }` + `scrollbar-width:none`。
7. keyframes：fadeIn、slideUp、pulse-soft、shake。

### 2.2 MobileContainer.tsx

- `max-w-[430px] mx-auto`：大屏居中，手机全宽。
- `h-dvh`：用 dvh 单位解决 Safari 地址栏问题。
- 安全区域 padding：`pt-[var(--sat)] pb-[var(--sab)]`。
- `bg-amber-950 overflow-hidden relative select-none`。
- mount 时给 html 加 `class="dark"`（shadcn 暗色主题）。
- mount 时监听 `window.visualViewport.resize`，更新 CSS 变量 `--visual-vh`。

### 2.3 socket.ts 单例

- `io(serverUrl, { autoConnect: false, reconnection: true, reconnectionAttempts: 5, reconnectionDelay: 1000 })`。
- 导出 `connectSocket()` 返回 Promise（connect resolve / connect_error reject）。
- 导出 `disconnectSocket()` 和 `socket` 实例。不注册业务事件。

### 2.4 useGameStore.ts Zustand

**状态**：isConnected、myId、myName（从 localStorage 恢复）、sessionToken（从 localStorage 恢复）、roomCode、gameState: ClientGameState | null、toastMessage。

**computed**（selector 模式）：myPlayer、phase、isHost、playerCount、isMyTurn。

**actions**：setConnected、setMyId、setMyName（同步 localStorage）、setSessionToken（同步 localStorage）、setRoomCode、updateGameState、showToast、clearToast、reset（保留 myName）。

localStorage key：`cheese_thief_name`、`cheese_thief_session`。

### 2.5 useSocket.ts

在 App.tsx 顶层调用一次。注册所有 S2C 事件监听，桥接到 store：
- connect/disconnect -> setConnected
- s2c:error -> showToast
- s2c:roomState / s2c:gameState -> updateGameState
- s2c:nightProgress -> 更新 night.currentDice
- s2c:nightYourTurn -> 合并到 night 字段
- s2c:nightActionResult -> 设置 viewedDice
- s2c:dayNewMessage -> 追加到本地 messages 数组（增量方案）
- s2c:voteUpdate -> 更新 votedCount
- s2c:gameResult -> 更新 result

cleanup 时 socket.off() 移除所有监听。

### 2.6 useCountdown.ts

参数 initialSeconds + onComplete。用 useRef 保存 interval ID。start/stop/reset 方法。每秒 remaining 减 1，到 0 调 onComplete。服务端定期推 remainingSeconds 做校准。

### 2.7 路由

`/ -> HomePage`、`/lobby/:roomCode -> LobbyPage`、`/game/:roomCode -> GamePage`。

路由守卫：LobbyPage 和 GamePage mount 时检查 store.roomCode，不匹配则用 sessionToken 尝试重连，失败跳 `/`。

页面切换用 AnimatePresence 做淡入淡出 200ms。

---

## 三、房间系统完整细节

### 3.1 RoomManager.ts

模块级单例。三个 Map：rooms（roomCode->GameRoom）、playerRoomMap（socketId->roomCode）、sessionMap（sessionToken->{roomCode,playerId}）。

**房间码生成**：从 32 字符集（去掉 I/O/0/1）随机取 4 个，冲突重生。

**createRoom**：生成码 -> new GameRoom -> new Player(isHost=true) -> socket.join -> 存三个 Map -> 返回 {roomCode, sessionToken}。

**joinRoom**：校验（房间存在、LOBBY 阶段、人数未满、昵称不重复）-> new Player -> 加入 GameRoom -> socket.join -> 存 Map -> 广播 roomState -> 返回 {roomCode, sessionToken}。

**leaveRoom**：移除玩家 -> 房主转移 -> 房间空则销毁 -> 否则广播 roomState -> 清 Map。

**reconnect**：sessionMap 找位置 -> 更新 socketId -> isConnected=true -> 清断线定时器 -> socket.join -> 推完整 gameState -> 广播重连通知。

**destroyRoom**：从 rooms 移除 -> 清所有相关 Map 条目。

### 3.2 GameRoom.ts

属性：roomCode、players[]、phase(初LOBBY)、settings(默认值)、engine(构造时创建)、thiefId、accompliceIds[]、cheeseStolen、nightActions[]、messages[]、io。

关键方法：
- **addPlayer / removePlayer / getPlayer / getPlayerBySession**：数组操作。
- **transferHost**：players[0].isHost = true。
- **resetForNewGame**：保留玩家基本信息，重置游戏状态，phase 回 LOBBY。
- **broadcastRoomState**：ViewBuilder 构建公开信息 -> io.to(roomCode).emit 广播。
- **sendGameState(playerId)**：ViewBuilder 为该玩家构建个性化状态 -> 单发。
- **broadcastGameState**：遍历每个在线玩家调 sendGameState（不能广播，每人数据不同）。

### 3.3 Player.ts

构造时：id=socketId、avatarIndex=random(0-7)、sessionToken=uuid()、isConnected=true。其他游戏属性初始 null/false/0。

额外属性：disconnectTimer（断线定时器）、chosenWakeDice（4人局贪睡鼠选的醒来点数）。

reset() 只重置游戏属性，不动 name/avatar/session/host/connected。

### 3.4 ViewBuilder.ts（防作弊核心）

`buildView(room, playerId) -> ClientGameState`

**players 数组构建**（对每个 ServerPlayer sp 生成 ClientPlayer cp）：

- role：自己可见 + RESULT 阶段全可见，否则 null。
- diceValues：自己可见 + 夜晚查看过的人可见（查 nightActions 记录）+ RESULT 全可见，否则 null。
- isAccomplice：RESULT 全可见；大盗看所有人的可见；共犯根据规则表（accomplicesKnowEachOther）看其他共犯可见；其他 null。
- voteCount / votedFor：仅 RESULT 可见。

**阶段子状态**：只在对应 phase 时非 null，其他时候 null。night/accomplice/day/vote/result 各自按当前玩家的权限填充。

---

## 四、游戏引擎各阶段完整细节

### 4.1 GameEngine.ts

纯调度器，不写阶段逻辑。方法链：
- startGame -> DealingPhase.run
- onAllDealingReady -> NightPhase.run
- onNightComplete -> 查 hasAccomplicePhase：是 -> AccomplicePhase.run，否 -> DayPhase.start
- onAccompliceComplete -> DayPhase.start
- onDayComplete -> VotePhase.start
- onVoteComplete -> ResultPhase.calculate -> phase=RESULT -> broadcastGameState

### 4.2 DealingPhase.run

1. 生成角色卡组：[THIEF] + 可选 SCAPEGOAT + 剩余全 SLEEPY。
2. Fisher-Yates 洗牌。
3. 分配 role，记录 thiefId。
4. 掷骰：1人1颗（4人局2颗）。
5. phase=DEALING，broadcastGameState。
6. 等所有人 dealingReady（4人贪睡鼠需附带 chosenWakeDice）。超时30秒自动 ready。
7. 全 ready 后 engine.onAllDealingReady。

### 4.3 NightPhase.run（最复杂）

phase=NIGHT，清空 nightActions 和 cheeseStolen。

**for dice = 1 to 6，每轮处理**：

1. 广播 NIGHT_PROGRESS { currentDice: dice }。
2. 找醒来玩家：普通局 diceValues[0]==dice；4人局大盗 diceValues.includes(dice)，贪睡鼠 chosenWakeDice==dice。
3. 没人醒来：等固定时间（不暴露信息），continue。
4. 有人醒来，按身份处理：

**大盗醒来**：
- 服务端自动执行 cheeseStolen=true + 记录 nightAction。
- 发 NIGHT_YOUR_TURN 含 mustStealCheese:true、同醒者列表。
- 同醒的贪睡鼠收到 cheeseStealVisible:true + stealerName。

**贪睡鼠/背锅鼠醒来**：
- 独自 + sleepyCanViewDice：canViewDice:true，等待 c2s:nightAction。
  - VIEW_DICE：校验（非自己、确实独自醒来），查目标骰子，记录 nightAction，单发结果。
  - SKIP 或超时：不做事。
- 独自 + 不能查看（4人局）：只通知独自醒来。
- 有人同醒：通知同醒者列表，什么都不能做。

**5人局自然共犯处理**：
- 大盗所在轮次，有贪睡鼠同醒：
  - 1个 -> 自动成为共犯。
  - 2个以上 -> 大盗选1个（超时随机）。
  - 0个 -> 无共犯。

5. 所有行动完成后等1秒过渡，进入下一点数。

6点结束后 engine.onNightComplete。

### 4.4 AccomplicePhase.run（6/7/8人）

5人局跳过（夜晚已处理）。

1. phase=ACCOMPLICE。
2. 给大盗发选人请求：候选人列表 + selectCount（6人选1，7/8人选2）。
3. 等大盗 c2s:accompliceSelect（超时8秒随机选）。校验数量和合法性。
4. 标记 isAccomplice，存 accompliceIds。
5. 根据人数规则相认：
   - **6人**：共犯知道大盗，大盗知道共犯。双方相认。
   - **7人**：共犯不知道大盗，但共犯互相认识。大盗知道两个共犯。
   - **8人**：三方全部互认。
6. 等5秒记忆时间。
7. engine.onAccompliceComplete。

### 4.5 DayPhase

start：phase=DAY，messages=[]，broadcastGameState，启动倒计时。每10秒广播一次 remainingSeconds 校准。房主可提前结束。

handleMessage：校验 phase+内容（非空、<=200字）+ 频率限制（每人每500ms最多1条）。构建 ChatMessage，push + 广播。

### 4.6 VotePhase

start：phase=VOTING，重置投票状态，broadcastGameState，启动倒计时。

handleVote：校验（VOTING阶段、未投过、不能投自己、target存在）-> 标记 -> 广播进度 -> 全投完则 endVoting。

forceEndVoting：超时未投的随机投一个 -> endVoting。

endVoting：统计票数（遍历 votedFor 给 target 加 voteCount）-> engine.onVoteComplete。

### 4.7 ResultPhase.calculate

1. 找最高票玩家（可能多人平票）。
2. 判断胜负（优先级：背锅鼠>大盗>其他）：
   - 翻牌有背锅鼠 -> NEUTRAL 胜。
   - 翻牌有大盗 -> GOOD 胜。
   - 都没有 -> EVIL 胜。
3. 构建复盘信息：所有人的 role、diceValues、isAccomplice、voteCount、votedFor。

---

## 五、前端页面交互细节

### 5.1 HomePage

- 昵称输入 + 创建/加入房间两个按钮。
- 创建：校验昵称(非空,<=8字) -> connectSocket -> emit createRoom -> 成功导航到 /lobby/:code。
- 加入：展开房间码输入(4位,自动大写,限字符集) -> connectSocket -> emit joinRoom -> 成功导航。
- 失败用 Toast 提示。

### 5.2 LobbyPage

- 顶部房间码 + 复制按钮（navigator.clipboard）。
- 玩家列表：PlayerSlot 显示头像+昵称+房主标记+自己标记。空位虚线。
- 设置区（仅房主）：讨论时间下拉(2/3/5分钟)、背锅鼠开关(6+人才显示)。
- 开始按钮（仅房主，>=4人可点）。
- 实时更新：服务端推 roomState 自动重渲染。断线玩家灰显。

### 5.3 GamePage

根据 phase 条件渲染对应 View 组件，AnimatePresence 做切换动画。不含业务逻辑。

### 5.4 DealingView

1. 卡牌翻转动画（Motion rotateY 600ms）揭示身份。
2. 延迟1秒后骰子滚动动画揭示点数。
3. 4人局贪睡鼠需要选择用哪个点数醒来（两个骰子选一个）。
4. "我记住了"按钮 -> emit dealingReady（4人贪睡鼠附带 chosenWakeDice）。

### 5.5 NightView

**非行动玩家**：深色背景 + 星空氛围 + 当前点数进度(1-6圆点) + 倒计时 + "请安静等待"。

**行动玩家 - 贪睡鼠独自醒来可查看**：显示其他玩家骰盅网格，点击一个查看 -> emit nightAction(VIEW_DICE) -> 收到结果显示"XX 的骰子是 N 点"。也可跳过。

**行动玩家 - 有人同醒**：显示同醒者名单 + "你什么都不能做，记住谁和你一起醒来"。

**行动玩家 - 大盗**：显示"你必须偷走奶酪" + 奶酪消失动画。如果有人同醒显示警告"XX 看到了你"。

### 5.6 AccompliceView

**大盗**：显示候选人头像网格，选 N 个 -> 确认 -> emit accompliceSelect。
**被选共犯**：显示"你被选为共犯" + 根据人数规则显示已知信息（大盗是谁/其他共犯是谁）。
**其他人**：等待界面。

### 5.7 DayView

上方 CountdownBar。中间 ChatPanel（消息列表，自己靠右别人靠左，自动滚底）。下方输入框+发送按钮。

iOS 键盘适配：用 flex 布局（非 fixed），监听 visualViewport resize 动态调整容器高度，键盘弹出时聊天区缩小输入框自然上移。

### 5.8 VoteView

顶部倒计时。中间所有玩家列表（除自己），可选一个高亮。进度显示"已投 X/Y"。确认投票 -> emit castVote。投完按钮灰显等待。

### 5.9 ResultView

1. **投票结果**：每人票数排名，最高票高亮。
2. **翻牌动画**：最高票玩家的身份卡翻转揭示。显示胜负文字。
3. **复盘区**：展开所有人真实信息（身份、骰子、共犯标记、投给谁）。
4. **底部**：房主显示"返回大厅再来一局"，非房主显示"等待房主"。

---

## 六、通用组件细节

- **PlayerAvatar**：根据 avatarIndex 显示预设头像（8个不同颜色老鼠，纯 CSS 或内联 SVG）。离线时灰度。
- **RoleCard**：正面身份图案 + 背面卡背。Motion rotateY 翻转。大盗红、贪睡鼠绿、背锅鼠紫。
- **DiceRoll**：CSS 3D transform 模拟六面骰。滚动动画 800ms 后显示结果。
- **CountdownBar**：shadcn Progress 改造，宽度按比例缩减，颜色绿->黄->红渐变。
- **CheeseToken**：奶酪图标，被偷时 scale->0 + opacity->0 消失动画 500ms。

---

## 七、断线重连完整流程

**客户端**：首次加入收到 sessionToken 存 localStorage。Socket 断开后自动重连，reconnect 成功后 emit c2s:reconnect { sessionToken, roomCode }。收到完整 gameState 恢复界面。

**服务端**：disconnect 时标记 isConnected=false + 设60秒定时器。60秒内收到 reconnect 则恢复绑定+推状态。超时则 removePlayer。夜晚等待该玩家行动时超时自动跳过。

---

## 八、4人双骰特殊处理汇总

- 每人掷2颗骰子。
- 贪睡鼠在 DEALING 阶段选一个点数醒来（chosenWakeDice）。
- 大盗两个点数都会醒（两次睁眼）。第一次偷奶酪，第二次只是睁眼。
- 贪睡鼠独自醒来也不能查看骰子（sleepyCanViewDice=false）。
- 没有共犯。不能用背锅鼠。

---

## 九、代码规范检查清单

每个文件写完对照：无 emoji、函数 <50 行（最多 100）、嵌套 <=3 层、数字字符串抽常量、无重复代码、变量名有意义、无注释掉的代码、无无用 import、异常不吞掉、配置走配置文件、用 IDE edit 工具不用 PowerShell。

---

*按此文档逐条实现，确保不丢任何逻辑分支和边界情况。*
