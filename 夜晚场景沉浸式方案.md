# 夜晚场景沉浸式体验 - 实现方案

## 现状分析

### 当前夜晚流程(服务端)
1. `startNightPhase()` 设置阶段，1.5s后开始轮转骰子
2. `advanceNightDice()` 依次处理骰子1-6，找到该点数醒来的玩家
3. `processNightTurn(awake)` 处理逻辑:
   - 小偷醒来 -> **自动偷窃**(问题所在) -> 目击者看到
   - 贪睡鼠独自醒来 -> 可偷看一个骰盅
   - 多人同时醒来 -> 互相看到
4. 30s倒计时，所有醒来的人点"继续"后推进下一点数
5. 骰子6结束后进入白天/帮凶阶段

### 当前问题
- 纯文字卡片，没有场景感
- 小偷偷窃是自动触发，玩家无法控制时机
- 睡着的玩家只看到"保持安静"文字，很无聊
- 偷看骰盅只是按钮列表 + 数字显示，没有动画
- 没有圆桌场景，看不到其他玩家状态

## 目标体验

### 醒来的玩家
看到一个**圆桌俯视场景**:
- 所有玩家围坐圆桌，每人一个座位
- **所有人都显示为贪睡鼠形象**(隐藏真实身份)
- 自己和其他醒来的人 -> 睁眼状态
- 其他睡着的人 -> 闭眼酣睡状态(带ZZZ)
- 桌子中央放着奶酪

### 小偷偷窃
- 小偷看到"偷窃"按钮，可以自主选择时机按下
- 按下后播放偷窃动画(老鼠手伸向桌中央奶酪)
- 倒计时结束仍未按 -> 强制触发偷窃
- 同时醒着的目击者能看到偷窃动画

### 贪睡鼠偷看骰盅
- 独自醒来的贪睡鼠看到场景 + 可点击其他玩家座位
- 点击后播放偷看动画(老鼠探头去看对方的骰盅)
- 骰盅翻开显示点数

### 睡着的玩家
- 深色星空背景 + "你正在沉睡..." 
- 当前骰子进度条，知道进行到第几个点数了
- 可以看到其他状态信息(已过的点数等)

---

## 详细实现计划

### 第1步: shared 层 - 类型和事件扩展

**文件: `shared/types.ts`**
- `ClientNightState` 新增字段:
  - `canSteal: boolean` - 小偷是否可以偷窃
  - `hasStolen: boolean` - 小偷是否已偷窃(用于播放动画)
  - `stealTimestamp: number | null` - 偷窃发生的时间戳(同步动画)
  - `seats: NightSeat[]` - 所有玩家的座位信息

- 新增类型 `NightSeat`:
  ```ts
  interface NightSeat {
    playerId: string
    playerName: string
    seatIndex: number
    isAwake: boolean
    isSelf: boolean
  }
  ```

**文件: `shared/events.ts`**
- 新增 `C2S.NIGHT_STEAL: 'c2s:nightSteal'`

### 第2步: server 层 - 小偷手动偷窃逻辑

**文件: `server/src/game/GameRoom.ts`**

修改 `processNightTurn`:
- 小偷醒来时不再自动 `this.cheeseStolen = true`
- 改为设置 `canSteal: true`，等待玩家手动触发
- `nightTurnData` 增加 `canSteal` / `hasStolen` 字段

新增 `handleNightSteal(playerId)`:
- 验证是小偷且 `canSteal === true`
- 设置 `cheeseStolen = true`, `hasStolen = true`
- 记录 `stealTimestamp = Date.now()`
- 记录 nightAction
- broadcastRoomUpdate (让目击者看到动画)

修改超时逻辑:
- `startNightTurnTimer` 超时时检查: 如果小偷在场且未偷窃 -> 先强制偷窃再推进

**文件: `server/src/game/ViewBuilder.ts`**

修改 `buildClientState`:
- night 对象增加 `seats` 数组构建
- 只有醒来的玩家能看到 `seats`(睡着的玩家 seats 为空)
- 增加 `canSteal` / `hasStolen` / `stealTimestamp` 字段

**文件: `server/src/socket/gameHandler.ts`**
- 注册 `C2S.NIGHT_STEAL` 事件处理

### 第3步: client 层 - 圆桌场景组件

**目录结构:**
```
client/src/components/game/night/
  NightScene.tsx       - 圆桌场景主容器
  RoundTable.tsx       - 圆桌 + 中央奶酪 SVG
  MouseSeat.tsx        - 单个座位上的老鼠(醒/睡两种状态)
  StealOverlay.tsx     - 小偷偷窃按钮 + 偷窃动画
  ViewDiceOverlay.tsx  - 偷看骰盅选择 + 偷看动画
  SleepingView.tsx     - 睡着玩家的视图
```

**NightScene.tsx**
- 醒来玩家的主视图
- 包含: StarField背景 + RoundTable + MouseSeat[] + 操作面板
- 根据角色显示不同操作: 偷窃按钮 / 偷看选择 / 仅观察

**RoundTable.tsx**
- SVG圆桌俯视图
- 中央放着Cheese(未被偷时) / 空位(已被偷后)
- 桌子周围等距分布座位槽

**MouseSeat.tsx**
- props: `seat: NightSeat`, `position: {x, y, angle}`
- 醒来状态: SleepyMouse睁眼版本 + 玩家名字
- 睡着状态: SleepyMouse闭眼(原版) + ZZZ + 玩家名字
- 自己的位置高亮标记

**StealOverlay.tsx**
- 显示条件: 小偷 + canSteal + !hasStolen
- 大按钮"偷窃!" + 倒计时环
- 按下 -> emit NIGHT_STEAL -> 播放偷窃动画
- 偷窃动画: 老鼠手从自己位置伸向桌子中央，奶酪消失

**ViewDiceOverlay.tsx**
- 显示条件: canViewDice + !viewedDice
- 场景中其他玩家座位可点击(高亮提示)
- 点击某人 -> emit NIGHT_ACTION(VIEW_DICE) -> 偷看动画
- 偷看动画: 自己的老鼠探头看向目标座位，骰盅翻开显示数字

**SleepingView.tsx**
- 睡着玩家的视图
- StarField背景 + 大号SleepyMouse(闭眼) + "你正在沉睡..."
- 底部显示骰子进度(当前进行到第几个)
- 安静等待

### 第4步: SVG资源 - 新增睁眼版老鼠

**文件: `client/src/assets/characters/SleepyMouseAwake.tsx`**
- 和SleepyMouse相同的造型，但眼睛完全睁开
- 用于圆桌场景中醒来的玩家

### 第5步: NightView 重写

**文件: `client/src/components/game/NightView.tsx`**

整体结构:
```tsx
if (!isMyTurn) {
  return <SleepingView currentDice={...} countdown={...} />
}
return <NightScene seats={...} ... />
```

NightScene 内部根据状态渲染不同操作面板:
- 小偷 + canSteal -> StealOverlay
- canViewDice -> ViewDiceOverlay
- 观察者(目击偷窃 / 多人同时醒来) -> 信息面板 + 继续按钮
- 已完成操作 -> 等待/继续按钮

### 第6步: 动画序列

**偷窃动画序列** (Framer Motion):
1. 按钮按下 -> 按钮消失
2. 自己的老鼠手臂伸出(0.3s)
3. 手触碰中央奶酪(0.3s)
4. 奶酪缩小消失(0.3s)
5. 文字浮现"奶酪到手!"(0.3s)
6. 1s后显示继续按钮

**偷看动画序列**:
1. 点击目标 -> 目标高亮
2. 自己的老鼠探头朝目标方向(0.4s)
3. 目标位置骰盅盖子掀开(0.3s)
4. DiceFace显示数字(0.3s, spring弹出)
5. 1s后显示继续按钮

**目击偷窃动画**:
1. 场景加载 -> 看到小偷位置的老鼠
2. 小偷的手伸向中央(同步动画，用stealTimestamp)
3. 奶酪消失
4. 感叹号浮现在小偷头上
5. 显示"你看到 XX 偷走了奶酪!"

---

## 工作量估算

| 步骤 | 文件数 | 预估改动量 | 难度 |
|------|--------|-----------|------|
| 1. shared类型扩展 | 2 | 小 | 低 |
| 2. server逻辑改造 | 3 | 中 | 中 |
| 3. 场景组件(6个) | 6 | 大 | 高 |
| 4. 睁眼老鼠SVG | 1 | 中 | 低 |
| 5. NightView重写 | 1 | 大 | 中 |
| 6. 动画调试 | - | 中 | 高 |

**总计**: 约13个文件需要新增或修改

## 执行顺序

建议严格按 1 -> 2 -> 4 -> 3 -> 5 -> 6 的顺序执行。
每步完成后编译验证，确保不引入错误。

## 注意事项

1. server端小偷偷窃改为手动，但必须保留超时强制偷窃，防止卡死
2. seats信息只发给醒来的玩家，睡着的玩家不应知道谁醒着
3. 圆桌座位用角度计算位置，支持4-8人动态排列
4. 偷窃动画需要通过stealTimestamp做多端同步
5. 所有老鼠在场景中都显示为贪睡鼠形象，不暴露身份
6. 旧的NightView代码可以完全替换，不需要保留
